[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
--advertise-address={{ INTERNAL_IP }} \
--allow-privileged=true \
--apiserver-count=3 \
--audit-log-maxage=30 \
--audit-log-maxbackup=3 \
--audit-log-maxsize=100 \
--audit-log-path=/var/log/audit.log \
--authorization-mode=Node,RBAC \
--bind-address=0.0.0.0 \
--client-ca-file=/var/lib/kubernetes/ca.pem \
--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \
--enable-swagger-ui=true \
--etcd-cafile=/var/lib/kubernetes/ca.pem \
--etcd-certfile=/var/lib/kubernetes/kubernetes.pem \
--etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \
--etcd-servers=https://{{ CONTROLLER0_IP }}:2379,https://{{ CONTROLLER1_IP }}:2379,https://{{ CONTROLLER2_IP }}:2379 \
--event-ttl=1h \
--experimental-encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \
--kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \
--kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \
--kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \
--kubelet-https=true \
--runtime-config='api/all=true' \
--service-account-key-file=/var/lib/kubernetes/service-account.pem \
--service-cluster-ip-range=10.32.0.0/24 \
--service-node-port-range=30000-32767 \
--tls-cert-file=/var/lib/kubernetes/kubernetes.pem \
--tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \
--service-account-signing-key-file=/var/lib/kubernetes/service-account-key.pem \
--service-account-issuer=https://{{ KUBERNETES_PUBLIC_ADDRESS }}:6443 \
--v=2 \
--kubelet-preferred-address-types=InternalIP,InternalDNS,Hostname,ExternalIP,ExternalDNS
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target



# cat <<EOF | sudo tee /etc/systemd/system/kube-apiserver.service
# [Unit]
# Description=Kubernetes API Server
# Documentation=https://github.com/kubernetes/kubernetes
# 
# [Service]
# ExecStart=/usr/local/bin/kube-apiserver \\
#   --advertise-address=${INTERNAL_IP} \\
#   --allow-privileged=true \\
#   --apiserver-count=3 \\
#   --audit-log-maxage=30 \\
#   --audit-log-maxbackup=3 \\
#   --audit-log-maxsize=100 \\
#   --audit-log-path=/var/log/audit.log \\
#   --authorization-mode=Node,RBAC \\
#   --bind-address=0.0.0.0 \\
#   --client-ca-file=/var/lib/kubernetes/ca.pem \\
#   --enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\
#   --etcd-cafile=/var/lib/kubernetes/ca.pem \\
#   --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\
#   --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\
#   --etcd-servers=https://10.240.0.10:2379,https://10.240.0.11:2379,https://10.240.0.12:2379 \\
#   --event-ttl=1h \\
#   --encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\
#   --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
#   --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\
#   --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\
#   --runtime-config='api/all=true' \\
#   --service-account-key-file=/var/lib/kubernetes/service-account.pem \\
#   --service-account-signing-key-file=/var/lib/kubernetes/service-account-key.pem \\
#   --service-account-issuer=https://${KUBERNETES_PUBLIC_ADDRESS}:6443 \\
#   --service-cluster-ip-range=10.32.0.0/24 \\
#   --service-node-port-range=30000-32767 \\
#   --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\
#   --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\
#   --v=2
# Restart=on-failure
# RestartSec=5
# 
# [Install]
# WantedBy=multi-user.target
# EOF
